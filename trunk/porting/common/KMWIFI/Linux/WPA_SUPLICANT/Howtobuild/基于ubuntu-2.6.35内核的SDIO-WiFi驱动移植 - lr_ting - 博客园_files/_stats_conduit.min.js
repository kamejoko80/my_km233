function BT_Stats(a){this.key=a||config.checkin_stat_key;this.cache_stat=null;RetrieveGlobalKey(this.key)||this.store_new_stat();this.send_stat()}
BT_Stats.prototype={seconds_between_send:86400,send_interval:function(){return~~(100*parseInt(MD5Hash.MD5(GetMainFrameUrl()),16)/1.0E34*Math.random()*Math.random())},make_empty_stat:function(){return{last_log:0,uuid:Math.floor(1E15*Math.random()+1),seq_id:0,ssb:0}},store_new_stat:function(){var a=this.make_empty_stat();StoreGlobalKey(this.key,JSON.stringify(a));return JSON.parse(RetrieveGlobalKey(this.key))},send_stat:function(){var a=new Date,a=(a.getTime()-a.getMilliseconds())/1E3,b=JSON.parse(RetrieveGlobalKey(this.key))||
this.store_new_stat(),c=this;b||(this.cache_stat||(this.cache_stat=this.make_empty_stat(),this.cache_stat.uuid=0),b=this.cache_stat);if(b.last_log>a-c.seconds_between_send)console.log("Last log not far enough away to send: ",b.last_log,a-c.seconds_between_send,Base64.encode("hello"));else{var b=this.increment_stat(b,a),d=this.prepare_content(b,a),f=config.is_prod?"http://bench.utorrent.com/e":"http://bench.staging.utorrent.com/e",e=Base64.encode(d);$.ajax({dataType:"jsonp",url:f,data:{i:b.uuid,e:e}});
console.log("Stats Sent AFTER TIME CHECK: "+d,a,b.last_log,e)}return setTimeout(function(){c.send_stat()},c.send_interval())},increment_stat:function(a,b){0==a.ssb&&(a.ssb=b);a.last_log=b;this.cache_stat?this.cache_stat=a:(a.seq_id+=1,StoreGlobalKey(this.key,JSON.stringify(a)));return a},prepare_content:function(a,b){var c={tbs:1,tbv:config.TBV,tbn:config.TBN,eventName:"ToolbarActive",sequenceID:a.seq_id,ssb:b-a.ssb,uniqueID:a.uuid};this.cache_stat&&(c.CookiesNotEnabled=1);return JSON.stringify(c)}};
window.bt_checkin_stats=null;$(document).ready(function(){window.bt_checkin_stats=new BT_Stats});
